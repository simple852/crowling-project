<!DOCTYPE html>
<html lang="kr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <!--폰트 어썸-->
    <script src="https://kit.fontawesome.com/d19fdaba43.js" crossorigin="anonymous"></script>
    <!--jquery-->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
</head>
<style>
    body{
        margin: 0;
        padding: 0;
    }
    header{
        width: 1200px;
        height: 50px;
        margin: 0 auto;
        display: flex;
        justify-content: right;
    }
    #refresh_btn:hover{
        cursor: pointer;
        background-color: rgba(0,0,0,0.2);
    }
    #sub_btn:hover{
        cursor: pointer;
        background-color: rgba(0,0,0,0.2);
    }
    header>i{
        font-size: 2rem;
        margin-top: 10px;
        margin-left: 20px;
    }

    main{
        width: 1200px;
        margin: 0 auto;
    }
    table{
        width: 100%;
        margin: 0 auto;
        border-top : 1px solid rgba(0,0,0,0.2);
        border-bottom : 1px solid rgba(0,0,0,0.2);
    }
    thead{
        text-align: center;
    }
    .item{
        height: 100px;
    }
    .item_text_con{
        width:60%;
        height: 100px;
    }
    .item_content{
        width: 100%;
        height: 100px;
        word-break:break-all;
    }
    .item_img_con{
        width: 100px;
        height: 100px;
    }
    .item_img_con>img{
        width: 100%;
        height: 100%;
    }
    .item_now_price,.item_save_price{
        width: 15%;
        height: 100px;
        text-align: center;
    }
    footer{
        width: 1200px;
        height: 50px;
        margin: 0 auto;
        display: flex;
        justify-content: center;
    }
    footer>a{
        margin-right: 5px;
    }
    .blue{
        color: blue;
    }
    .red{
        color: red;
    }
    .model_box{
        position:absolute;
        display: none;
        justify-content: center;
        top:0;
        left:0;
        width:100%;
        height:100%;
        background-color: rgba(0,0,0,0.4);
    }
    .model_body{
        position:absolute;
        top:30%;
        left:50%;
        width:300px;
        height:100px;

        padding:40px;
        text-align: center;
        background-color: rgb(255,255,255);
        border-radius:10px;
        box-shadow:0 2px 3px 0 rgba(34,36,38,0.15);

        transform:translate(-150px,-50px);
    }
    .model_input_con{
        display: flex;
        margin-bottom: 10px;
        justify-content: center;
        align-items: center;
    }
    .model_text{
        width: 80%;
    }
    .model_category{
        width: 20%;
    }
    footer{
        cursor: pointer;
    }
</style>
<body>
<header>
    <input class="model_btn" type="button" value="추가">
    <select name="" id="category">
        <option value="0">전체</option>
        <option value="1">CPU</option>
        <option value="2">RAM</option>
        <option value="3">메인보드</option>
        <option value="4">그래픽카드(VGA)</option>
        <option value="5">SSD</option>
    </select>
    <input th:value="${session.sessionId}" type="hidden" id ="sessionId">
    <i id="refresh_btn" class="fa-solid fa-arrows-rotate"></i>
    <i id="sub_btn" class="fa-regular fa-bell"></i>
</header>
<main>
    <table>
        <thead>
        <tr>
            <td>이미지</td>
            <td>상품</td>
            <td>현재가격</td>
            <td>세일</td>
        </tr>
        </thead>
        <tbody class="item_list">
        </tbody>
    </table>
</main>
<footer>
</footer>
<!--모달창-->
<div class="model_box">
    <div class="model_body">
        <h3>추가</h3>
        <div class="model_input_con">
            <select name="" class="model_category">
                <option value="0">전체</option>
                <option value="1">CPU</option>
                <option value="2">RAM</option>
                <option value="3">메인보드</option>
                <option value="4">그래픽카드(VGA)</option>
                <option value="5">SSD</option>
            </select>
            <input  class="model_text" type="text">
        </div>
        <input class="model_insert_btn" type="button" value="추가">
        <input class="model_close_btn" type="button" value="닫기">
    </div>
</div>
</body>
</html>
<script src="https://cdn.flarelane.com/WebSDK.js" charset="UTF-8"></script>
<script>
    FlareLane.initialize({ projectId: "a8b75707-136f-4fc3-ab47-57801d352e5f" });
    FlareLane.setUserId($("#sessionId").val());
    setInterval( reFreshItem(0),60000);

    ///////////////////////////////////////////////////////////////////////////
    //이벤트
    $("#category").change(()=>reFreshItem(0));

    //구독 버튼 클릭 이벤트
    $("#sub_btn").click(()=>{
        FlareLane.getIsSubscribed((isSubscribed) => {
            const sub_tag = document.getElementById("sub_btn");
            if(isSubscribed){
                FlareLane.setIsSubscribed(false);
                sub_tag.className = "fa-regular fa-bell-slash";
                alert("구독을 취소하였습니다.");
            }
            else{
                FlareLane.setIsSubscribed(true);
                sub_tag.className = "fa-regular fa-bell";
                alert("구독 하였습니다.");
            }
        });

    });
    //새로고침 버튼 클릭 이벤트
    $("#refresh_btn").click(()=>{
        alert("새로고침 되었습니다.");
        reFreshItem(0);
    });
    //모달 버튼 클릭 이벤트(모달창)
    $(".model_btn").click(()=>{
        $(".model_box").css("display","block");
    });
    //모달 종료 버튼 클릭
    $(".model_close_btn").click(()=>{
        $(".model_box").css("display","none");
    });
    $(".model_insert_btn").click(()=>{
        $(".model_box").css("display","none");
        $.ajax({
            type : "POST",
            data:{
                categoryId : $(".model_category").val(),
                itemAddress : $(".model_text").val(),
            },
            url : "/item/save",
            success : function(res){

            },
            error : function(){
            }
        });
    });
    ///////////////////////////////////////////////////////////////////////////
    //메서드

    //아이템 리스트 새로고침 메서드
    function reFreshItem(page){
        //현재 구독 상태를 가져와서 버튼을 바꿔준다.
        FlareLane.getIsSubscribed((isSubscribed) => {
            document.getElementById("sub_btn").className = isSubscribed?"fa-regular fa-bell":"fa-regular fa-bell-slash";
        });
        $.ajax({
            type : "GET",
            data:{
                category : $("#category").val(),
                page :{
                    page:page,
                    size:10
                }
            },
            url : "/shop/getItems",
            success : function(res){
                $(".item_list").empty();
                res.forEach(item => {
                    if(item.totalItemCount!=null){
                        $("footer").empty();
                        for (let i = 0; i < item.totalItemCount/10; i++) {
                            var $aTage = $('<a href="#">'+i+'</a>');
                            $aTage.click((event)=>{
                                reFreshItem(Number(event.currentTarget.textContent));
                            });
                            $("footer").append($aTage);
                        }
                    }
                    var $itemBox = $(
                        '<tr class="item">\n' +
                        '<td class="item_img_con">\n' +
                        '<img src="'+item.itemImage+'" alt="">\n' +
                        '</td>\n' +
                        '<td class="item_text_con">\n' +
                        '<strong><a href="'+item.itemAddress+'" class="item_name">'+item.itemName+'</a></strong>\n' +
                        '<div class="item_content">'+item.itemContent+'</div>\n' +
                        '</td>\n' +
                        '<td class="item_now_price">'+item.itemPrice+'</td>\n' +
                        '<td class="item_save_price">'+

                        item.itemGap + (item.itemGap>0 ?'<i class="fa-solid fa-arrow-trend-up red"></i>':(Number(item.itemGap) == 0 ?'':'<i class="fa-solid fa-arrow-trend-down blue"></i>')) +
                        '</td>' +
                        '</tr>');
                    $(".item_list").append($itemBox);
                });
            },
            error : function(XMLHttpRequest, textStatus, errorThrown){ // 비동기 통신이 실패할경우 error 콜백으로 들어옵니다.
                console.log("통신실패")
                $(".item_list").empty();
                $("footer").empty();
            }
        });
    }

</script>